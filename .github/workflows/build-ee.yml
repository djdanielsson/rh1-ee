---
name: Build Execution Environment

on:
  push:
    branches: [main, master]
    paths:
      - 'execution-environment.yml'
      - 'requirements.yml'
      - 'requirements.txt'
      - 'bindep.txt'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Push image to registry'
        type: boolean
        default: false

jobs:
  build:
    name: Build EE Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ansible-builder
        run: |
          pip install ansible-builder
          ansible-builder --version

      - name: Set image tag
        id: set-tag
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            TAG="dev-$(git rev-parse --short HEAD)"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            TAG="pr-${{ github.event.pull_request.number }}"
          else
            TAG="test-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Image tag: $TAG"

      - name: Build EE with ansible-builder
        run: |
          ansible-builder build \
            --tag myorg-custom-ee:${{ steps.set-tag.outputs.tag }} \
            --container-runtime podman \
            --verbosity 3

      - name: Test EE image
        run: |
          # Test ansible version
          podman run --rm myorg-custom-ee:${{ steps.set-tag.outputs.tag }} ansible --version
          
          # Test collection list
          podman run --rm myorg-custom-ee:${{ steps.set-tag.outputs.tag }} ansible-galaxy collection list

      - name: Scan image for vulnerabilities
        run: |
          # Install trivy
          wget https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Linux-64bit.tar.gz
          tar zxvf trivy_0.48.0_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/
          
          # Scan image
          trivy image --severity HIGH,CRITICAL myorg-custom-ee:${{ steps.set-tag.outputs.tag }}

      - name: Save image
        run: |
          podman save myorg-custom-ee:${{ steps.set-tag.outputs.tag }} | gzip > ee-image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ee-image-${{ steps.set-tag.outputs.tag }}
          path: ee-image.tar.gz
          retention-days: 30

  # Optional: Push to registry
  push:
    name: Push to Registry
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.push_image == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Quay.io
        uses: redhat-actions/podman-login@v1
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and push
        run: |
          TAG="dev-$(git rev-parse --short HEAD)"
          
          # Build
          ansible-builder build \
            --tag quay.io/myorg/custom-ee:$TAG \
            --container-runtime podman
          
          # Push
          podman push quay.io/myorg/custom-ee:$TAG
          
          echo "âœ… Pushed quay.io/myorg/custom-ee:$TAG"



