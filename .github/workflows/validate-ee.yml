name: Validate Execution Environment

on:
  pull_request:
    paths:
      - 'execution-environment.yml'
      - 'requirements.yml'
      - 'requirements.txt'
      - 'bindep.txt'
  push:
    branches:
      - main
    paths:
      - 'execution-environment.yml'
      - 'requirements.yml'
      - 'requirements.txt'
      - 'bindep.txt'

jobs:
  validate:
    name: Validate EE Definition
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          python3 -c "import yaml; yaml.safe_load(open('execution-environment.yml'))"
          python3 -c "import yaml; yaml.safe_load(open('requirements.yml'))"
          echo "✅ YAML syntax valid"

      - name: Validate version pinning
        run: |
          echo "Checking for version pinning violations..."

          # Check requirements.yml for version ranges
          if grep -E "version:\s*[><=~]" requirements.yml; then
            echo "❌ ERROR: Version ranges found in requirements.yml"
            echo "Use exact versions only (e.g., version: '1.0.0')"
            exit 1
          fi

          # Check requirements.yml for missing versions
          if grep -E "^\s*-\s*name:" requirements.yml | grep -v "version:"; then
            echo "❌ ERROR: Collections without version specified"
            echo "All collections must have explicit versions"
            exit 1
          fi

          # Check requirements.txt for unpinned versions
          if grep -E "^[^#].*[><=~]" requirements.txt; then
            echo "⚠️  WARNING: Version ranges found in requirements.txt"
            echo "Consider pinning to exact versions for reproducibility"
          fi

          echo "✅ Version pinning validated"

      - name: Validate base image
        run: |
          BASE_IMAGE=$(grep -A 2 "base_image:" execution-environment.yml | grep "name:" | awk '{print $2}' | tr -d '"')

          if [[ "$BASE_IMAGE" == *":latest"* ]] || [[ -z "$BASE_IMAGE" ]]; then
            echo "❌ ERROR: Base image must be pinned (no :latest tag)"
            echo "Current: $BASE_IMAGE"
            echo "Use a specific tag or digest"
            exit 1
          fi

          echo "✅ Base image validated: $BASE_IMAGE"

      - name: Check required files
        run: |
          REQUIRED_FILES=("execution-environment.yml" "requirements.yml" "requirements.txt" "bindep.txt")

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ ERROR: Required file missing: $file"
              exit 1
            fi
          done

          echo "✅ All required files present"

      - name: Validate ansible-builder syntax
        run: |
          pip install ansible-builder
          ansible-builder create --build-arg EE_BASE_IMAGE=quay.io/centos/centos:stream9-minimal || true
          echo "✅ ansible-builder syntax validated"
