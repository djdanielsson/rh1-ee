# Ansible Execution Environment Example

**Purpose**: Custom Execution Environment for Ansible Automation Platform
**Repository**: https://github.com/djdanielsson/rh1-custom-ee.git
**Built with**: ansible-builder

## Overview

This repository contains the definition for a custom Execution Environment (EE) - a container image that includes Ansible, Python dependencies, system packages, and collections needed to run your automation.

**Constitution Compliance**: Article IV (Production-Grade Quality)

## What is an Execution Environment?

An Execution Environment is a container image that serves as the runtime for Ansible playbooks in AAP. It contains:
- Ansible Core
- Python libraries
- System packages
- Ansible Collections
- Custom dependencies

### Why Use Custom EEs?

1. **Consistency**: Same environment across dev/qa/prod
2. **Reproducibility**: Locked versions, no "works on my machine"
3. **Dependencies**: Include specific Python libs, system packages
4. **Collections**: Bundle your custom collections
5. **Version Control**: EE definition in Git, image tagged

## Repository Structure

```
automation-ee-example/
├── README.md                       # This file
├── execution-environment.yml       # Main EE definition
├── requirements.yml                # Ansible collections
├── requirements.txt                # Python dependencies
├── bindep.txt                      # System packages
├── .gitignore                      # Git ignore patterns
└── context/                        # Additional build context (optional)
    └── custom-files/

```

## EE Definition Files

### 1. execution-environment.yml

Main configuration file for ansible-builder:

```yaml
---
version: 3

images:
  base_image:
    name: registry.redhat.io/ansible-automation-platform-25/ee-minimal-rhel9:latest

dependencies:
  galaxy: requirements.yml
  python: requirements.txt
  system: bindep.txt

additional_build_steps:
  prepend_base:
    - RUN echo "Custom EE for myorg"

  append_final:
    - RUN chmod -R ug+rwx /runner

options:
  package_manager_path: /usr/bin/microdnf
```

### 2. requirements.yml

Ansible collections to include:

```yaml
---
collections:
  - name: myorg.custom_collection
    type: git
    source: https://github.com/djdanielsson/rh1-custom-collection.git
    version: main

  - name: infra.aap_configuration
    version: ">=2.9.0"

  - name: ansible.posix
    version: ">=1.5.0"
```

### 3. requirements.txt

Python dependencies:

```
# Ansible itself (if not in base image)
# ansible-core>=2.15

# Python libraries your automation needs
requests>=2.31.0
jinja2>=3.1.2
pyyaml>=6.0
netaddr>=0.9.0

# For specific modules
# boto3>=1.28.0  # AWS
# kubernetes>=28.1.0  # K8s
# pymongo>=4.5.0  # MongoDB
```

### 4. bindep.txt

System packages (RPMs):

```
# System tools
git [platform:rpm]
rsync [platform:rpm]
openssh-clients [platform:rpm]

# Network tools
iputils [platform:rpm]
bind-utils [platform:rpm]

# Development tools (if needed)
# gcc [platform:rpm]
# python3-devel [platform:rpm]
```

## Building the EE

### Local Build

```bash
# Install ansible-builder
pip install ansible-builder

# Build the EE
ansible-builder build -t myorg-custom-ee:latest

# Test the EE
podman run -it myorg-custom-ee:latest ansible --version
```

### Build with Tags

```bash
# Build with version tag
ansible-builder build -t myorg-custom-ee:26.01.06.0

# Build with multiple tags
ansible-builder build \
  -t myorg-custom-ee:26.01.06.0 \
  -t myorg-custom-ee:latest
```

### Build and Push

```bash
# Build
ansible-builder build -t quay.io/myorg/custom-ee:26.01.06.0

# Login to registry
podman login quay.io

# Push
podman push quay.io/myorg/custom-ee:26.01.06.0
```

## Testing the EE

### Test Ansible Version

```bash
podman run -it myorg-custom-ee:latest ansible --version
```

### Test Collections

```bash
podman run -it myorg-custom-ee:latest \
  ansible-galaxy collection list
```

### Test Python Dependencies

```bash
podman run -it myorg-custom-ee:latest \
  python3 -c "import requests; print(requests.__version__)"
```

### Test with Playbook

```bash
# Run a test playbook
podman run -it \
  -v $(pwd)/playbooks:/playbooks \
  myorg-custom-ee:latest \
  ansible-playbook /playbooks/test.yml
```

## CI/CD Integration

### Build Pipeline

The EE is built automatically when:
1. Code is pushed to `main` branch
2. A version tag is created (e.g., `26.01.06.0`)

### Tekton Pipeline

```yaml
# Simplified Tekton task
- name: build-ee
  taskRef:
    name: buildah-build
  params:
    - name: IMAGE
      value: quay.io/myorg/custom-ee:$(params.VERSION)
    - name: CONTEXT
      value: automation-ee-example/
    - name: DOCKERFILE
      value: automation-ee-example/context/Dockerfile  # Generated by ansible-builder
```

### Image Tagging Strategy

- **Development**: `myorg-custom-ee:dev` (rebuilt on every commit)
- **QA**: `myorg-custom-ee:26.01.06.0` (locked version from manifest)
- **Production**: `myorg-custom-ee:26.01.06.0` (locked version from manifest)

## Atomic Promotion

EE images are version-locked in release manifests:

```yaml
# automation-release-manifest/releases/26.01.06.0.yaml
version: "26.01.06.0"
components:
  execution_environment:
    image: "quay.io/myorg/custom-ee"
    tag: "26.01.06.0"
    digest: "sha256:abc123..."
  aap_configuration: "commit-sha-123"
  collections: "commit-sha-456"
```

## Best Practices

### 1. Pin Versions

Always pin versions in `requirements.yml` and `requirements.txt`:

```yaml
# Good
collections:
  - name: community.general
    version: "9.0.0"

# Bad
collections:
  - name: community.general  # No version = latest
```

### 2. Minimal Base Image

Start with `ee-minimal-rhel9` and only add what you need:

```yaml
images:
  base_image:
    name: registry.redhat.io/ansible-automation-platform-25/ee-minimal-rhel9:latest
```

### 3. Test Before Push

Always test the EE locally before pushing:

```bash
ansible-builder build -t test-ee:local
podman run -it test-ee:local ansible-playbook test.yml
```

### 4. Security Scanning

Scan images for vulnerabilities:

```bash
# Using podman
podman scan quay.io/myorg/custom-ee:26.01.06.0

# Using trivy
trivy image quay.io/myorg/custom-ee:26.01.06.0
```

### 5. Keep Images Small

- Don't install unnecessary packages
- Clean up build artifacts
- Use multi-stage builds if needed

## Troubleshooting

### Build Fails

```bash
# Enable verbose output
ansible-builder build -t test-ee --verbosity 3

# Check the generated Containerfile
cat context/Containerfile
```

### Collection Not Found

```bash
# Verify collections in built image
podman run -it myorg-custom-ee:latest \
  ansible-galaxy collection list
```

### Python Import Error

```bash
# Check Python packages
podman run -it myorg-custom-ee:latest \
  pip list
```

### Permission Issues

```bash
# Check file permissions
podman run -it myorg-custom-ee:latest \
  ls -la /runner
```

## Development Workflow

### 1. Make Changes

```bash
# Edit EE definition
vi execution-environment.yml

# Add new collection
vi requirements.yml

# Add new Python dependency
vi requirements.txt
```

### 2. Build Locally

```bash
ansible-builder build -t myorg-custom-ee:test
```

### 3. Test

```bash
# Test ansible version
podman run -it myorg-custom-ee:test ansible --version

# Test collections
podman run -it myorg-custom-ee:test \
  ansible-galaxy collection list

# Test with playbook
podman run -it -v $(pwd):/work myorg-custom-ee:test \
  ansible-playbook /work/test.yml
```

### 4. Commit and Push

```bash
git add .
git commit -m "Add new collection to EE"
git push origin main
```

### 5. Tag Release

```bash
# Tag for production
git tag -a 26.01.06.0 -m "Release 26.01.06.0"
git push origin 26.01.06.0

# CI builds and pushes: myorg-custom-ee:26.01.06.0
```

## Using the EE in AAP

### Configure in AAP

1. Navigate to **Administration** → **Execution Environments**
2. Click **Add**
3. Enter:
   - Name: `Custom EE`
   - Image: `quay.io/myorg/custom-ee:26.01.06.0`
   - Pull: `Always` (dev) or `Missing` (prod)

### Use in Job Template

```yaml
# In aap-config-as-code/group_vars/aap_dev/job_templates.yml
controller_job_templates_dev:
  - name: "My Job"
    execution_environment: "Custom EE"
    project: "My Project"
    playbook: "playbook.yml"
```

## Image Registry

### Recommended Registries

1. **Quay.io** (recommended)
   - Free for public repos
   - Security scanning
   - Good for open source

2. **OpenShift Internal Registry**
   - `image-registry.openshift-image-registry.svc:5000`
   - Good for private/internal use

3. **Red Hat Registry**
   - `registry.redhat.io`
   - For base images only

## Links

### Related Repositories
- **Cluster Config** (Platform GitOps): https://github.com/djdanielsson/rh1-cluster-config
- **AAP Config as Code**: https://github.com/djdanielsson/rh1-aap-config-as-code
- **Ansible Collection**: https://github.com/djdanielsson/rh1-custom-collection
- **Release Manifests**: https://github.com/djdanielsson/rh1-release-manifest

### Documentation
- **Project Workspace**: https://github.com/djdanielsson/rh1_ansible_code_lifecycle
- **Platform Specs**: https://github.com/djdanielsson/rh1_ansible_code_lifecycle/tree/main/specs/001-cloud-native-ansible-lifecycle

### External Resources
- **ansible-builder Docs**: https://ansible.readthedocs.io/projects/builder/
- **AAP EE Guide**: https://access.redhat.com/documentation/en-us/red_hat_ansible_automation_platform/2.5/html/creating_and_consuming_execution_environments/
- **Base Images**: https://catalog.redhat.com/software/containers/search

---

**Last Updated**: 2025-10-29
**Maintained By**: Platform Team
**Questions**: File issue in this repository

