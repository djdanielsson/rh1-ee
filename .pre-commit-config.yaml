---
# Pre-commit hooks for automation-ee-example repository
# Execution Environment - ansible-builder configuration
#
# Installation:
#   pip install pre-commit
#   pre-commit install
#
# Run manually:
#   pre-commit run --all-files

repos:
  # ============================================================================
  # General Checks - All Files
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Prevent large files from being committed
      - id: check-added-large-files
        args: ['--maxkb=500']
        
      # Ensure files end with newline
      - id: end-of-file-fixer
        
      # Remove trailing whitespace
      - id: trailing-whitespace
        args: ['--markdown-linebreak-ext=md']
        
      # Verify YAML syntax
      - id: check-yaml
        
      # Check for merge conflict markers
      - id: check-merge-conflict
        
      # Prevent committing to main/master directly
      - id: no-commit-to-branch
        args: ['--branch', 'main', '--branch', 'master']
        
      # Check case conflicts
      - id: check-case-conflict

  # ============================================================================
  # YAML Linting
  # ============================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.33.0
    hooks:
      - id: yamllint
        args:
          - '--config-file=.yamllint'
        files: \.(yaml|yml)$

  # ============================================================================
  # Security Scanning - Secrets Detection
  # ============================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args:
          - '--baseline'
          - '.secrets.baseline'
        exclude: |
          (?x)^(
            \.secrets\.baseline
          )$

  # ============================================================================
  # GitLeaks - Additional Secrets Detection
  # ============================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.1
    hooks:
      - id: gitleaks

  # ============================================================================
  # Markdown Linting
  # ============================================================================
  - repo: https://github.com/markdownlint/markdownlint
    rev: v0.12.0
    hooks:
      - id: markdownlint
        args: ['--rules', '~MD013,~MD033']

  # ============================================================================
  # EE Structure Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: ee-structure
        name: EE Structure Check
        entry: |
          bash -c 'required_files=("execution-environment.yml" "requirements.yml" "requirements.txt" "bindep.txt")
          for file in "${required_files[@]}"; do 
            if [ ! -f "$file" ]; then 
              echo "❌ Required file not found: $file"
              exit 1
            fi
          done
          echo "✅ EE structure valid"'
        language: system
        pass_filenames: false
        always_run: true

  # ============================================================================
  # Execution Environment YAML Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: ee-yaml-validation
        name: Execution Environment YAML Validation
        entry: |
          bash -c 'if [ -f execution-environment.yml ]; then python3 -c "import yaml; ee=yaml.safe_load(open(\"execution-environment.yml\")); assert \"version\" in ee, \"Missing version\"; assert \"images\" in ee, \"Missing images\"; assert \"dependencies\" in ee, \"Missing dependencies\"" || { echo "❌ Invalid execution-environment.yml"; exit 1; }; echo "✅ execution-environment.yml valid"; fi'
        language: system
        files: ^execution-environment\.yml$
        pass_filenames: false

  # ============================================================================
  # Base Image Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: base-image-check
        name: Base Image Validation
        entry: |
          bash -c 'if [ -f execution-environment.yml ]; then if ! grep -q "registry.redhat.io/ansible-automation-platform" execution-environment.yml && ! grep -q "quay.io/ansible" execution-environment.yml; then echo "⚠️  WARNING: Consider using official AAP base images"; fi; fi'
        language: system
        files: ^execution-environment\.yml$
        pass_filenames: false

  # ============================================================================
  # Requirements.yml Validation (Collections)
  # ============================================================================
  - repo: local
    hooks:
      - id: requirements-yml-validation
        name: Requirements.yml Validation
        entry: |
          bash -c 'if [ -f requirements.yml ]; then python3 -c "import yaml; reqs=yaml.safe_load(open(\"requirements.yml\")); assert \"collections\" in reqs, \"Missing collections key\"" || { echo "❌ Invalid requirements.yml"; exit 1; }; echo "✅ requirements.yml valid"; fi'
        language: system
        files: ^requirements\.yml$
        pass_filenames: false

  # ============================================================================
  # Version Pinning Check
  # ============================================================================
  - repo: local
    hooks:
      - id: version-pinning-collections
        name: Collection Version Pinning Check
        entry: |
          bash -c 'if [ -f requirements.yml ]; then if grep -E "^\s+-\s+name:" requirements.yml | grep -v "version:" -A1 | grep -v "type: git" -A1 | grep "name:"; then echo "⚠️  WARNING: Some collections may not have pinned versions"; echo "Best practice: Pin all collection versions for reproducibility"; fi; fi'
        language: system
        files: ^requirements\.yml$
        pass_filenames: false

      - id: version-pinning-python
        name: Python Version Pinning Check
        entry: |
          bash -c 'if [ -f requirements.txt ]; then if grep -v "^#" requirements.txt | grep -v "^$" | grep -v "==\|>=\|<=\|~="; then echo "⚠️  WARNING: Some Python packages may not have pinned versions"; echo "Best practice: Pin versions (e.g., package==1.2.3)"; fi; fi'
        language: system
        files: ^requirements\.txt$
        pass_filenames: false

  # ============================================================================
  # No Latest Tags in Production
  # ============================================================================
  - repo: local
    hooks:
      - id: no-latest-tags
        name: No Latest Tags Check
        entry: |
          bash -c 'if [ -f execution-environment.yml ]; then if grep -q ":latest" execution-environment.yml; then echo "⚠️  WARNING: Using :latest tag in base image"; echo "Constitution Article III: Use specific versions for reproducibility"; echo "Consider pinning to specific version tag"; fi; fi'
        language: system
        files: ^execution-environment\.yml$
        pass_filenames: false

  # ============================================================================
  # Bindep.txt Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: bindep-validation
        name: Bindep.txt Validation
        entry: |
          bash -c 'if [ -f bindep.txt ]; then while IFS= read -r line; do [[ "$line" =~ ^#.*$ ]] && continue; [[ -z "$line" ]] && continue; if ! [[ "$line" =~ ^[a-zA-Z0-9_-]+(\s+\[.*\])?(\s+#.*)?$ ]]; then echo "⚠️  WARNING: Possibly invalid bindep line: $line"; fi; done < bindep.txt; echo "✅ bindep.txt format ok"; fi'
        language: system
        files: ^bindep\.txt$
        pass_filenames: false

  # ============================================================================
  # Dockerfile Not Allowed (Use ansible-builder)
  # ============================================================================
  - repo: local
    hooks:
      - id: no-manual-dockerfile
        name: No Manual Dockerfile
        entry: |
          bash -c 'if [ -f Dockerfile ] || [ -f Containerfile ]; then echo "❌ VIOLATION: Manual Dockerfile/Containerfile not allowed"; echo "Use execution-environment.yml and ansible-builder"; echo "Dockerfiles should be in context/ directory only (generated)"; exit 1; fi'
        language: system
        files: ^(Dockerfile|Containerfile)$
        pass_filenames: false

  # ============================================================================
  # Constitutional Compliance
  # ============================================================================
  - repo: local
    hooks:
      - id: no-secrets
        name: No Secrets in EE Config
        entry: |
          bash -c 'echo "Checking for secrets..."
          for f in "$@"; do 
            if grep -iE "(password|secret|token|api[_-]?key):\s*[\"'\''][^{]" "$f" | grep -v "^#"; then 
              echo "❌ VIOLATION: Possible secret in $f"
              echo "Constitution Article V: No secrets in Git"
              exit 1
            fi
          done
          echo "✅ No secrets detected"'
        language: system
        files: \.(yaml|yml|txt)$
        pass_filenames: true

  # ============================================================================
  # Build Test (Optional - can be slow)
  # ============================================================================
  - repo: local
    hooks:
      - id: ee-build-test
        name: EE Build Test (Syntax)
        entry: |
          bash -c 'if command -v ansible-builder &> /dev/null; then echo "Testing EE definition..."; ansible-builder create --verbosity 1 || { echo "❌ ansible-builder create failed"; exit 1; }; echo "✅ EE definition valid"; rm -rf context; else echo "⚠️  ansible-builder not found, skipping build test"; fi'
        language: system
        pass_filenames: false
        # Comment out 'always_run' to disable this check by default (can be slow)
        # always_run: true

  # ============================================================================
  # Documentation Check
  # ============================================================================
  - repo: local
    hooks:
      - id: readme-check
        name: README Exists Check
        entry: |
          bash -c 'if [ ! -f README.md ]; then echo "❌ README.md not found"; exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true



